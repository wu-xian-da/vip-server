<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jianfei.core.mapper.RoleMapper">

	<resultMap id="roleResult" type="Role">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="description" column="description" />
		<collection property="resources" ofType="Resource">
			<id property="id" column="resources.id" />
			<result column="resources.name" property="name" />
		</collection>
	</resultMap>

	<select id="get" resultMap="roleResult" parameterType="java.util.Map">
		SELECT
		sr.`id`,
		sr.`name`,
		sr.`description`,
		res.`id` AS
		'resources.id',
		res.`name` AS 'resources.name'
		FROM `sys_roles` sr
		LEFT
		JOIN
		`sys_role_resource` srr ON sr.`id`=srr.`roleId`
		LEFT JOIN
		`sys_resources` res ON srr.`resourceId`=res.`id`
		<where>
			<if test="id!=null">
				sr.id =#{id}
			</if>
			<if test="notLikeName!=null">
				and sr.name=#{notLikeName}
			</if>
			<if test="name!=null">
				and sr.name like CONCAT('%', #{name}, '%')
			</if>
			<if test="description!=null">
				and sr.description like CONCAT('%', #{description}, '%')
			</if>
		</where>
	</select>

	<insert id="save" parameterType="Role">
		INSERT INTO sys_roles
		(
			name,
			description,
			createdatetime,
			updatedatetime
		)
		VALUES
		(
			#{name},
			#{description},
			#{createdatetime},
			#{updatedatetime}
		)
	</insert>
	
	<update id="update" parameterType="Role">
		UPDATE 
		  sys_roles 
		SET
		  name = name,
		  description = #{description},
		  updatedatetime = #{updatedatetime} 
		WHERE id = #{id}
	</update>

	<delete id="delete" parameterType="Long">
		delete from sys_roles where id=#{id}
	</delete>

	<delete id="deleteByResourceFromRole" parameterType="Long">
		delete from sys_role_resource where roleId=#{roleId}
	</delete>
	
	<insert id="batchInsertRoleResource" parameterType="ArrayList">
		INSERT INTO sys_role_resource (roleId,resourceId)
		VALUES
		<foreach collection="list" item="item" index="index"
			separator=",">
			(#{item.roleId}, #{item.resourceId})
		</foreach>
	</insert>
	
	<select id="selectRoleByUserId" parameterType="Long" resultMap="roleResult">
			SELECT  role.* FROM sys_roles role INNER JOIN sys_users_roles sur ON role.id=sur.role_id WHERE sur.user_id=#{id}
	</select>

</mapper>