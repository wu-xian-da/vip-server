<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jianfei.core.mapper.UserMapper">

	<resultMap id="userRs" type="User">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="password" column="password" />
		<result property="loginName" column="loginName" />
		<result property="salt" column="salt" />
		<result property="locked" column="locked" />
		<result property="type" column="type" />
		<result property="sex" column="sex" />
		<result property="delTag" column="delTag" />
		<result property="photo" column="photo" />
		<result property="createdatetime" column="createdatetime" />
		<result property="updatedatetime" column="updatedatetime" />
		<collection property="roles" ofType="Role">
			<id property="id" column="resources.id" />
			<id property="name" column="resources.name" />
		</collection>
	</resultMap>

	<select id="get" resultMap="userRs" parameterType="java.util.Map">
		SELECT * from sys_users
		<where>
			<if test="1==1">
				delTag=0
			</if>
			<if test="id!=null">
				and id=#{id}
			</if>
			<if test="name!=null">
				and name like CONCAT('%', #{name}, '%')
			</if>
			<if test="loginName!=null">
				and loginName like CONCAT('%', #{loginName}, '%')
			</if>
			<if test="sex!=null">
				and sex = #{sex}
			</if>
			<if test="start!=null">
				and createdatetime &gt; #{start}
			</if>
			<if test="ends!=null">
				and createdatetime &lt; #{ends}
			</if>
		</where>
		<if test="sort!=null">
			order by ${sort} ${order}
		</if>
	</select>
	<select id="getUserByName" resultMap="userRs" parameterType="String">
		SELECT * from sys_users where loginName =#{loginName}
	</select>

	<insert id="save" parameterType="User">
		INSERT INTO
		sys_users(photo,name,password,salt,locked,loginName,createdatetime,updatedatetime,sex,delTag)
		VALUES(#{photo},#{name},#{password},#{salt},#{locked},
		#{loginName},#{createdatetime},#{updatedatetime},#{sex},#{delTag}
		)
	</insert>

	<update id="update" parameterType="User">
		<if test="id!=0">
			update sys_users set updatedatetime=#{updatedatetime}
			<if test="name!=null">
				,name=#{name}
			</if>
			<if test="password!=null">
				,password=#{password}
			</if>
			<if test="photo!=null">
				,photo=#{photo}
			</if>
			<if test="locked!=null">
				,password=#{locked}
			</if>
			<if test="loginName!=null">
				,loginName=#{loginName}
			</if>
			,sex=#{sex},delTag=#{delTag} where id=#{id}
		</if>
	</update>

	<delete id="delete" parameterType="Long">
		update sys_users set delTag =1 where id=#{id}
	</delete>

	<delete id="deleteRolesFromUser" parameterType="Long">
		DELETE FROM
		`sys_users_roles` WHERE `user_id`=#{userId}
	</delete>


	<insert id="batchInsertUserRole" parameterType="ArrayList">
		INSERT INTO sys_users_roles (user_id,role_id)
		VALUES
		<foreach collection="list" item="item" index="index"
			separator=",">
			( #{item.userId},#{item.roleId}	)
		</foreach>
	</insert>

</mapper>